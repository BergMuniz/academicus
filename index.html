<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academicus AI | Studio Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        /**
         * CONFIGURAÇÃO DE DESIGN INSTITUCIONAL
         * Define o sistema de cores baseado na identidade visual Christus/INEP.
         */
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        inep: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        bloomSky: { 100: '#e0f2fe', 800: '#075985', border: '#7dd3fc' },
                        bloomBlue: { 100: '#dbeafe', 800: '#1e40af', border: '#93c5fd' },
                        bloomIndigo: { 100: '#e0e7ff', 800: '#3730a3', border: '#a5b4fc' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { background-color: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }

        /* ARQUITETURA DE INTERFACE (CARDS E ESTADOS) */
        .type-card { border: 1px solid #e2e8f0; border-radius: 20px; background: white; padding: 18px; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); overflow: hidden; }
        .type-card.active { border-color: #0284c7; box-shadow: 0 15px 30px -5px rgba(2, 132, 199, 0.15); }
        .radio-circle { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #cbd5e1; flex-shrink: 0; transition: all 0.2s; }
        .type-card.active .radio-circle { border-color: #0284c7; border-width: 7px; }

        /* CONTAINER DE EXEMPLOS PEDAGÓGICOS */
        .example-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 14px; padding: 16px; margin-top: 14px; font-size: 0.75rem; color: #475569; line-height: 1.7; white-space: pre-wrap; border-left: 5px solid #cbd5e1; }
        
        /* ESCADA DE DIFICULDADE (SISTEMA DE BARRAS) */
        .diff-card { border-radius: 16px; border: 1px solid #e2e8f0; padding: 12px; height: 100px; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; cursor: pointer; background: white; transition: all 0.2s; }
        .diff-bar { width: 100%; border-radius: 6px 6px 0 0; margin-bottom: 8px; background: #e2e8f0; transition: all 0.3s; }
        .diff-card.active-medium { background: #eff6ff; border-color: #60a5fa; }
        .diff-card.active-medium .diff-bar { background: #3b82f6; }

        /* PIRÂMIDE DE BLOOM (HIERARQUIA VISUAL) */
        .bloom-pyramid-btn { padding: 10px; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.3s; background: white; color: #64748b; }
        .bloom-pyramid-btn.active { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #bloom-Criar.active, #bloom-Avaliar.active { background: #4f46e5; color: white; border-color: #4f46e5; }
        #bloom-Analisar.active, #bloom-Aplicar.active { background: #2563eb; color: white; border-color: #2563eb; }
        #bloom-Entender.active, #bloom-Lembrar.active { background: #0ea5e9; color: white; border-color: #0ea5e9; }

        /* SELETORES E BOTÕES TÉCNICOS */
        .key-btn { width: 40px; height: 40px; border-radius: 12px; border: 1px solid #e2e8f0; font-weight: 900; background: white; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .key-btn.active { background: #0284c7; color: white; border-color: #0284c7; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(2, 132, 199, 0.2); }
        .ctrl-btn { padding: 8px 12px; border-radius: 10px; font-size: 0.7rem; font-weight: 800; border: 1px solid #e2e8f0; background: white; color: #64748b; flex: 1; display: flex; justify-content: center; }
        .ctrl-btn.active { background: #0284c7; border-color: #0284c7; color: white; }

        /* ESTILIZAÇÃO DO RELATÓRIO PROFISSIONAL */
        .prose h3 { color: #0c4a6e; font-size: 1.2rem; font-weight: 900; border-bottom: 3px solid #e0f2fe; margin-top: 2.5rem; margin-bottom: 1.5rem; padding-bottom: 0.6rem; text-transform: uppercase; }
        .prose p { margin-bottom: 1.5rem; line-height: 1.8; text-align: justify; font-size: 1rem; }
        .prose li { display: block; margin-bottom: 1.2rem; }
        .gabarito-box { background: #f0fdf4; border: 1px solid #86efac; border-left: 8px solid #16a34a; padding: 2rem; border-radius: 20px; margin-top: 4rem; }
        
        input, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 h-20 flex items-center px-4 lg:px-12 justify-between shadow-sm">
        <div class="flex items-center gap-5">
            <div class="bg-inep-600 p-2.5 rounded-2xl text-white shadow-xl shadow-inep-100"><i data-lucide="graduation-cap" class="w-7 h-7"></i></div>
            <div class="leading-tight">
                <h1 class="text-2xl font-black text-slate-900 tracking-tighter uppercase">Academicus AI</h1>
                <p class="text-[11px] font-black text-inep-500 uppercase tracking-widest mt-1">Studio de Criação de Questões</p>
            </div>
        </div>
        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
            <button onclick="setMode('generator')" id="tab-gen" class="px-6 py-2.5 rounded-xl text-xs font-black bg-white shadow-lg text-inep-700 uppercase transition-all">Design</button>
            <button onclick="setMode('auditor')" id="tab-aud" class="px-6 py-2.5 rounded-xl text-xs font-black text-slate-500 hover:text-slate-800 uppercase transition-all">Auditoria</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-4 lg:p-12 grid grid-cols-1 lg:grid-cols-12 gap-12 flex-1">
        
        <aside class="lg:col-span-5 space-y-10">
            <div id="panel-generator" class="space-y-10">
                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-2xl space-y-8">
                    <h3 class="text-lg font-black text-slate-800 uppercase flex items-center gap-3 pb-4 border-b border-slate-50">
                        <i data-lucide="book-open" class="text-inep-600"></i> Especificações
                    </h3>
                    <div class="space-y-6">
                        <input id="curso" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm outline-none focus:bg-white font-medium transition-all" placeholder="Curso / Área...">
                        <textarea id="conteudo" rows="4" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm resize-none outline-none focus:bg-white font-medium transition-all" placeholder="Objeto de Conhecimento..."></textarea>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-6">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest block">Nível de Dificuldade</label>
                    <div class="grid grid-cols-3 gap-3">
                        <div onclick="setDiff('Fácil')" id="diff-Fácil" class="diff-card"><div class="diff-bar" style="height:35%"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Fácil</span></div>
                        <div onclick="setDiff('Médio')" id="diff-Médio" class="diff-card active-medium"><div class="diff-bar" style="height:65%; background:#3b82f6"></div><span class="text-[10px] font-bold text-inep-700 uppercase">Médio</span></div>
                        <div onclick="setDiff('Difícil')" id="diff-Difícil" class="diff-card"><div class="diff-bar" style="height:100%"></div><span class="text-[10px] font-bold text-slate-500 uppercase">Difícil</span></div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[2.5rem] border border-slate-200 shadow-sm space-y-6">
                    <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest block">Taxonomia de Bloom</label>
                    <div class="flex flex-col items-center gap-1.5 bg-slate-50 p-5 rounded-[2.5rem] border border-slate-100">
                        <button onclick="setBloom('Criar')" id="bloom-Criar" class="bloom-pyramid-btn w-[40%]">Criar</button>
                        <button onclick="setBloom('Avaliar')" id="bloom-Avaliar" class="bloom-pyramid-btn w-[50%]">Avaliar</button>
                        <button onclick="setBloom('Analisar')" id="bloom-Analisar" class="bloom-pyramid-btn w-[60%]">Analisar</button>
                        <button onclick="setBloom('Aplicar')" id="bloom-Aplicar" class="bloom-pyramid-btn w-[70%]">Aplicar</button>
                        <button onclick="setBloom('Entender')" id="bloom-Entender" class="bloom-pyramid-btn w-[80%]">Entender</button>
                        <button onclick="setBloom('Lembrar')" id="bloom-Lembrar" class="bloom-pyramid-btn active w-[90%]">Lembrar</button>
                    </div>
                    <div id="bloom-info-box" class="mt-4 p-5 rounded-2xl border hidden">
                        <h4 id="bloom-info-title" class="font-black text-sm mb-1 uppercase text-bloomSky-800"></h4>
                        <p id="bloom-info-desc" class="text-xs italic mb-4 leading-relaxed text-slate-600 font-medium"></p>
                        <div class="pt-3 border-t border-black/5">
                            <span class="text-[10px] font-black uppercase opacity-60">Verbos Sugeridos</span>
                            <p id="bloom-info-verbs" class="text-xs font-bold mt-1 text-slate-800"></p>
                        </div>
                    </div>
                </div>

                <div id="types-container" class="space-y-4"></div>

                <div class="bg-white p-7 rounded-[2.5rem] border border-slate-200 shadow-sm flex items-center justify-between">
                    <span class="text-xs font-black uppercase text-slate-500 tracking-widest">Quantidade</span>
                    <div class="flex items-center gap-5">
                        <button onclick="updateQty(-1)" class="w-12 h-12 border-2 rounded-xl bg-white shadow-sm flex items-center justify-center font-black">-</button>
                        <span id="qty-val" class="font-black text-slate-900 text-2xl w-8 text-center">1</span>
                        <button onclick="updateQty(1)" class="w-12 h-12 border-2 rounded-xl bg-white shadow-sm flex items-center justify-center font-black">+</button>
                    </div>
                </div>

                <button onclick="gerar()" id="btn-main" class="w-full bg-inep-600 text-white font-black py-6 rounded-[2rem] shadow-2xl active:scale-95 hover:bg-inep-700 transition-all text-xl uppercase tracking-tighter">Gerar Questão Studio Pro</button>
            </div>

            <div id="panel-auditor" class="hidden bg-white p-10 rounded-[3rem] border border-slate-200 shadow-sm text-center">
                <div class="p-4 bg-emerald-50 rounded-2xl inline-block mb-6"><i data-lucide="microscope" class="w-12 h-12 text-emerald-600"></i></div>
                <h3 class="font-black text-emerald-800 text-xl uppercase tracking-tighter">Auditoria Técnica</h3>
                <textarea id="audit-input" class="w-full p-6 bg-slate-50 border border-slate-200 rounded-[2rem] mt-8 mb-8 text-sm font-mono h-80 outline-none focus:bg-white transition-all" placeholder="Cole a questão completa (Texto-base, Enunciado e Alternativas) para laudo..."></textarea>
                <button onclick="auditar()" id="btn-aud" class="w-full bg-emerald-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-emerald-700 transition-all uppercase">Executar Auditoria</button>
            </div>
        </aside>

        <div id="result-anchor" class="lg:col-span-7">
            <div class="bg-white min-h-[900px] border border-slate-200 rounded-[3.5rem] shadow-2xl p-8 lg:p-16 relative flex flex-col">
                <div id="tools" class="flex justify-end gap-4 mb-12 opacity-0 transition-all duration-1000">
                    <button onclick="exportWord()" class="px-6 py-3 border-2 border-blue-100 rounded-2xl text-xs font-black text-blue-700 bg-blue-50 hover:bg-blue-100">Word</button>
                    <button onclick="exportPdf()" class="px-6 py-3 border-2 border-red-100 rounded-2xl text-xs font-black text-red-700 bg-red-50 hover:bg-red-100">PDF</button>
                </div>
                <div id="placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-12 opacity-20">
                    <i data-lucide="sparkles" class="w-24 h-24 text-slate-300 mb-8"></i>
                    <h3 class="text-3xl font-black text-slate-400 uppercase tracking-[0.3em]">Studio</h3>
                </div>
                <div id="output" class="hidden prose prose-slate max-w-none text-base leading-relaxed animate-fade-in font-medium"></div>
            </div>
        </div>
    </main>

    <script>
        /**
         * MÓDULO DE DADOS E ESTADOS
         */
        const BLOOM_INFO = {
            "Criar": { color: "indigo", desc: "Produzir um novo ponto de vista ou produto.", verbs: "GERAR, PLANEJAR, DESENVOLVER, CONSTRUIR, PROJETAR." },
            "Avaliar": { color: "indigo", desc: "Fazer julgamentos baseados em critérios.", verbs: "JULGAR, CRITICAR, SELECIONAR, VALIDAR, REVISAR." },
            "Analisar": { color: "blue", desc: "Separar material em partes constituintes.", verbs: "DIFERENCIAR, ORGANIZAR, ATRIBUIR, DECOMPOR, INVESTIGAR." },
            "Aplicar": { color: "blue", desc: "Executar ou usar um procedimento em uma situação específica.", verbs: "EXECUTAR, IMPLEMENTAR, USAR, DEMONSTRAR, RESOLVER." },
            "Entender": { color: "sky", desc: "Construir significado a partir de mensagens.", verbs: "EXPLICAR, RESUMIR, INFERIR, PARAFRASEAR, INTERPRETAR." },
            "Lembrar": { color: "sky", desc: "Recuperar conhecimento relevante da memória.", verbs: "CITAR, DEFINIR, LISTAR, IDENTIFICAR, RECORDAR." }
        };

        const ASSERTION_LOGIC = { 'A': 'As asserções I e II são verdadeiras, e a II justifica a I.', 'B': 'As asserções I e II são verdadeiras, mas a II não justifica a I.', 'C': 'A asserção I é verdadeira, e a II é falsa.', 'D': 'A asserção I é falsa, e a II é verdadeira.', 'E': 'As asserções I e II são falsas.' };

        const TYPES = {
            "SINGLE": { label: "Resposta Única", icon: "check-circle", example: "Texto suporte denso (+500 caracteres).\n\n<strong>Fonte:</strong> Junqueira, L. Biologia Celular. 2012.\n\nQual a função técnica do conceito apresentado.\n\na) Alternativa correta.\nb) Distrator.\nc) Distrator.\nd) Distrator.\ne) Distrator." },
            "INCOMPLETE": { label: "Afirmação Incompleta", icon: "pen-tool", example: "O fenômeno descrito no texto fundamentado é caracterizado pela\n\n<strong>Fonte:</strong> Pesquisa NAP 2026.\n\na) alternativa correta.\nb) alternativa incorreta.\nc) alternativa incorreta.\nd) alternativa incorreta.\ne) alternativa incorreta." },
            "MULTIPLE": { label: "Complementação Múltipla", icon: "layers" },
            "ASSERTION": { label: "Asserção e Razão", icon: "git-compare" },
            "DISCURSIVE": { label: "Discursiva", icon: "file-text", example: "Texto suporte denso (+500 caracteres).\n\n<strong>Fonte:</strong> UNESCO. IA e Educação. 2023.\n\nCom base no texto, redija um texto dissertativo analisando.\n\na) Tópico técnico um.\nb) Tópico técnico dois.\nc) Tópico técnico três." }
        };

        let STATE = { diff: 'Médio', bloom: 'Lembrar', type: 'SINGLE', assertionKey: 'A', multiRange: 5, quantity: 1 };

        /**
         * MÓDULO DE INTERFACE (UI)
         */
        function init() { renderTypes(); lucide.createIcons(); setBloom('Lembrar'); }

        function renderTypes() {
            const container = document.getElementById('types-container');
            container.innerHTML = '';
            Object.entries(TYPES).forEach(([key, info]) => {
                const active = STATE.type === key;
                const div = document.createElement('div');
                div.className = `type-card ${active ? 'active' : ''}`;
                div.onclick = () => { STATE.type = key; renderTypes(); };
                let html = `<div class="flex items-center gap-4"><i data-lucide="${info.icon}" class="w-6 h-6 text-inep-600"></i><div class="flex-1 font-bold text-sm text-slate-800 uppercase tracking-tighter">${info.label}</div><div class="radio-circle"></div></div>`;
                
                if (active) {
                    let exText = info.example || "";
                    // Lógica para Complementação Múltipla (I a V)
                    if (key === 'MULTIPLE') {
                        let cmd = STATE.multiRange === 3 ? "É correto o que se afirma em" : "É correto apenas o que se afirma em";
                        let alts = STATE.multiRange === 3 ? "a) I, apenas.\nb) II, apenas.\nc) III, apenas.\nd) I e II, apenas.\ne) I, II e III." : "a) I e II.\nb) I, III e IV.\nc) II e IV.\nd) II, III e IV.\ne) I, II, III e IV.";
                        let itemsStr = "I. Item um.\nII. Item dois.\nIII. Item três.";
                        if(STATE.multiRange >= 4) itemsStr += "\nIV. Item quatro.";
                        if(STATE.multiRange == 5) itemsStr += "\nV. Item cinco.";
                        exText = `Texto denso (+500 caracteres).\n\n<strong>Fonte:</strong> Referência Real.\n\nAvalie as afirmações a seguir.\n\n${itemsStr}\n\n${cmd}\n\n${alts}`;
                    }
                    // Lógica para Asserção e Razão
                    if (key === 'ASSERTION') {
                        exText = `Texto técnico fundamentado.\n\n<strong>Fonte:</strong> Katz, J. 1999.\n\nAnalise as asserções e a relação proposta.\n\nI. Proposição um.\n\n<div class=\"text-center font-bold py-3\">PORQUE</div>\n\nII. Razão dois.\n\nA respeito dessas asserções, assinale a opção correta.\n\na) ${ASSERTION_LOGIC['A']}\nb) ${ASSERTION_LOGIC['B']}\nc) ${ASSERTION_LOGIC['C']}\nd) ${ASSERTION_LOGIC['D']}\ne) ${ASSERTION_LOGIC['E']}`;
                    }
                    html += `<div class="example-box font-medium">${exText}</div>`;
                    
                    // Controles de Configuração Técnica
                    if (key === 'MULTIPLE') {
                        html += `<div class="mt-5 flex gap-2">`;
                        [3,4,5].forEach(n => {
                            html += `<button onclick="event.stopPropagation(); STATE.multiRange=${n}; renderTypes();" class="ctrl-btn ${STATE.multiRange===n?'active':''}">I a ${n===3?'III':n===4?'IV':'V'}</button>`;
                        });
                        html += `</div>`;
                    }
                    if (key === 'ASSERTION') {
                        html += `<div class="mt-5 flex gap-2">`;
                        ['A','B','C','D','E'].forEach(l => {
                            html += `<button onclick="event.stopPropagation(); STATE.assertionKey='${l}'; renderTypes();" class="key-btn ${STATE.assertionKey===l?'active':''}" title="${l}">${l}</button>`;
                        });
                        html += `</div><div class="mt-4 p-4 bg-slate-50 rounded-2xl text-[10px] font-bold text-inep-700 italic border-l-4 border-inep-500 animate-fade-in shadow-sm">${ASSERTION_LOGIC[STATE.assertionKey]}</div>`;
                    }
                }
                div.innerHTML = html; container.appendChild(div);
            });
            lucide.createIcons();
        }

        /**
         * MÓDULO DE DIFICULDADE & BLOOM
         */
        function setDiff(val) {
            STATE.diff = val;
            document.querySelectorAll('.diff-card').forEach(el => {
                el.classList.remove('active-medium'); const bar = el.querySelector('.diff-bar'); bar.style.backgroundColor = '#e2e8f0';
                if(el.id.includes(val)) { el.classList.add('active-medium'); bar.style.backgroundColor = '#3b82f6'; }
            });
        }

        function setBloom(val) {
            STATE.bloom = val; const info = BLOOM_INFO[val];
            document.querySelectorAll('.bloom-pyramid-btn').forEach(b => { b.classList.remove('active'); if(b.id === `bloom-${val}`) b.classList.add('active'); });
            const box = document.getElementById('bloom-info-box'); box.classList.remove('hidden');
            document.getElementById('bloom-info-title').innerText = val;
            document.getElementById('bloom-info-desc').innerText = info.desc;
            document.getElementById('bloom-info-verbs').innerText = info.verbs;
        }

        function updateQty(n) { STATE.quantity = Math.max(1, Math.min(10, STATE.quantity + n)); document.getElementById('qty-val').innerText = STATE.quantity; }

        /**
         * MÓDULO DE NAVEGAÇÃO (SWITCH DE ESTADO)
         * FIX: Limpa e reseta a área de saída ao alternar modos.
         */
        function setMode(mode) {
            const isGen = mode === 'generator';
            document.getElementById('panel-generator').classList.toggle('hidden', !isGen);
            document.getElementById('panel-auditor').classList.toggle('hidden', isGen);
            document.getElementById('tab-gen').className = isGen ? "px-6 py-2.5 rounded-xl text-xs font-black bg-white shadow-lg text-inep-700 uppercase" : "px-6 py-2.5 rounded-xl text-xs font-black text-slate-500 hover:text-slate-800 transition-all uppercase";
            document.getElementById('tab-aud').className = !isGen ? "px-6 py-2.5 rounded-xl text-xs font-black bg-white shadow-lg text-inep-700 uppercase transition-all" : "px-6 py-2.5 rounded-xl text-xs font-black text-slate-500 hover:text-slate-800 transition-all uppercase";
            
            // RESET ABSOLUTO DA TELA DE SAÍDA
            document.getElementById('output').classList.add('hidden');
            document.getElementById('output').innerHTML = '';
            document.getElementById('placeholder').classList.remove('hidden');
            document.getElementById('tools').classList.add('opacity-0');
        }

        /**
         * MOTOR DE GERAÇÃO (CORE AI)
         */
        async function gerar() {
            const btn = document.getElementById('btn-main'); const curso = document.getElementById('curso').value; const conteudo = document.getElementById('conteudo').value;
            if(!curso || !conteudo) return alert("Erro: Campos obrigatórios.");
            btn.innerHTML = 'Construindo Questão Profissional...'; btn.disabled = true;

            let promptExtras = "";
            if (STATE.type === 'ASSERTION') promptExtras = `GABARITO: Letra ${STATE.assertionKey}. Gere alternativas A-E padrão ENADE. O PORQUE deve vir centralizado: <div style="text-align:center; font-weight:bold; margin:15px 0;">PORQUE</div>.`;
            if (STATE.type === 'MULTIPLE') {
                let cmd = STATE.multiRange === 3 ? "É correto o que se afirma em" : "É correto apenas o que se afirma em";
                let altsReq = STATE.multiRange === 3 ? "Use 'apenas' nas alternativas (ex: I, apenas.)." : "NÃO use 'apenas' nas alternativas.";
                promptExtras = `COMANDO: "${cmd}" (SEM PONTO FINAL). BALANCEAMENTO: Gere 5 alternativas (A-E). Cada numeral romano (I a ${STATE.multiRange}) deve aparecer EXATAMENTE 3 VEZES na soma total das alternativas A-E. ${altsReq}`;
            }
            if (STATE.type === 'INCOMPLETE') promptExtras = `REGRA: Enunciado SEM ponto final. Alternativas minúsculas.`;
            if (STATE.type === 'DISCURSIVE') promptExtras = `ESTRUTURA: Itens a), b) e c) obrigatórios em linhas separadas. GRADE DE CORREÇÃO: Título centralizado e negrito: <div style="text-align:center; font-weight:bold; margin-top:30px; text-transform:uppercase;">GRADE DE CORREÇÃO</div>. ITENS DA GRADE: "Critério - Descrição" sem pontos numéricos.`;

            const prompt = `Atue como Especialista INEP. NUNCA use "Prezado docente," ou rótulos ("Texto de suporte:", "Fonte:", "Comando:", "Itens:"). QUANTIDADE: ${STATE.quantity}. REGRAS: Texto base +500 caracteres fundamentados. Fonte real abaixo do texto base em HTML: <strong>Fonte:</strong> [Referência]. Itens/Alternativas um abaixo do outro com quebra de linha. Explicação pedagógica profunda no final. Separe por "---". ${promptExtras}`;

            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
                const data = await res.json();
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('output').classList.remove('hidden');
                document.getElementById('tools').classList.remove('opacity-0');
                document.getElementById('output').innerHTML = marked.parse(data.text);
                if (window.innerWidth < 1024) setTimeout(() => { document.getElementById('result-anchor').scrollIntoView({ behavior: 'smooth' }); }, 100);
            } catch(e) { alert("Erro na API."); } finally { btn.innerHTML = 'Gerar Questão Studio Pro'; btn.disabled = false; }
        }

        /**
         * MOTOR DE AUDITORIA (ROTEIRO ESPECIALISTA)
         */
        async function auditar() {
            const txt = document.getElementById('audit-input').value; if(!txt) return alert("Erro: Cole a questão completa.");
            const btn = document.getElementById('btn-aud'); btn.innerHTML = 'Executando Laudo Técnico...'; btn.disabled = true;
            
            const promptAuditor = `Atue como um Revisor Técnico e Pedagógico especialista em avaliações do INEP.
            Objetivo: Realize uma auditoria de qualidade rigorosa no item abaixo. Sua função é identificar falhas estruturais, pedagógicas e de conteúdo.
            Entrada: ${txt}
            Checklist de Validação:
            1. Alinhamento Cognitivo (Taxonomia de Bloom): A questão exige raciocínio complexo? Verbo de comando adequado?
            2. Análise do Texto-Base: Teste de Indispensabilidade. Se removido, a questão ainda pode ser respondida? Texto motivador ou decorativo?
            3. Engenharia de Distratores: São plausíveis? Há "pegadinhas"? Simetria gramatical?
            4. Travas de Segurança: Vazamento gramatical no enunciado? Norma culta? Viés?
            Saída Obrigatória:
            - Veredito: [APROVADA / APROVADA COM RESSALVAS / REPROVADA]
            - Análise Detalhada justificando o veredito.
            - Sugestão de Melhoria com reescrita técnica.`;

            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: promptAuditor }) });
                const data = await res.json();
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('output').classList.remove('hidden');
                document.getElementById('output').innerHTML = marked.parse(data.text);
            } catch(e) { alert("Erro na auditoria."); } finally { btn.innerHTML = 'Executar Auditoria'; btn.disabled = false; }
        }

        /**
         * MÓDULOS DE EXPORTAÇÃO
         */
        function exportWord() {
            const text = document.getElementById('output').innerText; const lines = text.split('\n');
            const doc = new docx.Document({ sections: [{ children: lines.map(line => new docx.Paragraph({ children: [new docx.TextRun({ text: line, size: 24, font: "Arial" })], spacing: { after: 200 } })) }] });
            docx.Packer.toBlob(doc).then(blob => saveAs(blob, "Questao_StudioPro_Relatorio.docx"));
        }

        function exportPdf() { const el = document.getElementById('output'); html2pdf().set({ margin: 20, filename: 'Relatorio_Academicus_StudioPro.pdf', image: { type: 'jpeg', quality: 1 }, html2canvas: { scale: 3 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).from(el).save(); }

        // Inicialização do sistema
        init();
    </script>
</body>
</html>
