<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academicus AI | Studio Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        inep: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 900: '#0c4a6e' },
                        bloomSky: { 100: '#e0f2fe', 800: '#075985' },
                        bloomBlue: { 100: '#dbeafe', 800: '#1e40af' },
                        bloomIndigo: { 100: '#e0e7ff', 800: '#3730a3' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { background-color: #f8fafc; color: #1e293b; -webkit-font-smoothing: antialiased; }

        .type-card { border: 1px solid #e2e8f0; border-radius: 12px; background: white; padding: 16px; cursor: pointer; transition: all 0.2s; overflow: hidden; }
        .type-card.active { border-color: #0284c7; box-shadow: 0 0 0 1px #0284c7; }
        .radio-circle { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #cbd5e1; flex-shrink: 0; transition: all 0.2s; }
        .type-card.active .radio-circle { border-color: #0284c7; border-width: 6px; }

        .example-box { background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; margin-top: 12px; font-size: 0.75rem; color: #475569; line-height: 1.6; white-space: pre-wrap; }
        .example-header { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; }

        .ctrl-btn { padding: 8px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; border: 1px solid #e2e8f0; background: white; color: #64748b; flex: 1; display: flex; justify-content: center; }
        .ctrl-btn.active { background: #0284c7; border-color: #0284c7; color: white; }

        .key-btn { width: 40px; height: 40px; border-radius: 8px; border: 1px solid #e2e8f0; font-weight: 700; background: white; flex: 1; display: flex; align-items: center; justify-content: center; }
        .key-btn.active { background: #0284c7; color: white; border-color: #0284c7; }

        .bloom-btn { border: 1px solid #e2e8f0; padding: 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; text-align: center; color: #64748b; background: white; width: 100%; }
        .bloom-btn.active.sky { background: #e0f2fe; border-color: #7dd3fc; color: #0369a1; }
        .bloom-btn.active.blue { background: #dbeafe; border-color: #93c5fd; color: #1e40af; }
        .bloom-btn.active.indigo { background: #e0e7ff; border-color: #a5b4fc; color: #3730a3; }

        .prose h3 { color: #0c4a6e; font-size: 1.1rem; font-weight: 800; border-bottom: 2px solid #e0f2fe; margin-top: 2rem; margin-bottom: 1rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; text-align: justify; }
        .prose li { display: block; margin-bottom: 0.8rem; }
        .gabarito-box { background: #f0fdf4; border: 1px solid #86efac; border-left: 5px solid #16a34a; padding: 1.5rem; border-radius: 8px; margin-top: 2rem; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white border-b border-slate-200 sticky top-0 z-50 h-16 flex items-center px-4 lg:px-6 justify-between shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-inep-600 p-2 rounded-lg text-white"><i data-lucide="graduation-cap" class="w-5 h-5"></i></div>
            <div class="leading-tight">
                <h1 class="text-lg lg:text-xl font-bold text-slate-900 leading-none">Academicus AI</h1>
                <p class="text-[10px] lg:text-xs text-slate-500 font-medium">Studio de Criação de Questões</p>
            </div>
        </div>
        <div class="flex bg-slate-100 p-1 rounded-lg">
            <button onclick="setMode('generator')" id="tab-gen" class="px-3 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-inep-700">Design</button>
            <button onclick="setMode('auditor')" id="tab-aud" class="px-3 py-1.5 rounded-md text-xs font-bold text-slate-500">Auditoria</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto w-full p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1">
        
        <aside class="lg:col-span-5 space-y-6">
            <div id="panel-generator" class="space-y-6">
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                    <h3 class="text-sm font-bold text-slate-800 flex items-center gap-2"><i data-lucide="book-open" class="w-4 h-4 text-inep-600"></i> Contexto</h3>
                    <input id="curso" class="w-full p-3 border rounded-xl text-sm outline-none focus:border-inep-500" placeholder="Curso...">
                    <textarea id="conteudo" rows="3" class="w-full p-3 border rounded-xl text-sm resize-none outline-none focus:border-inep-500" placeholder="Conteúdo..."></textarea>
                </div>

                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-4">
                    <label class="text-xs font-bold text-slate-500 uppercase block">Taxonomia de Bloom</label>
                    <div class="flex flex-col gap-1.5">
                        <button onclick="setBloom('Criar')" id="bloom-Criar" class="bloom-btn">Criar</button>
                        <button onclick="setBloom('Avaliar')" id="bloom-Avaliar" class="bloom-btn">Avaliar</button>
                        <button onclick="setBloom('Analisar')" id="bloom-Analisar" class="bloom-btn">Analisar</button>
                        <button onclick="setBloom('Aplicar')" id="bloom-Aplicar" class="bloom-btn">Aplicar</button>
                        <button onclick="setBloom('Entender')" id="bloom-Entender" class="bloom-btn">Entender</button>
                        <button onclick="setBloom('Lembrar')" id="bloom-Lembrar" class="bloom-btn active sky">Lembrar</button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm space-y-3">
                    <label class="text-xs font-bold text-slate-500 uppercase block">Modelo da Questão</label>
                    <div id="types-container" class="space-y-3"></div>
                </div>

                <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <span class="text-xs font-bold uppercase text-slate-700">Quantidade (até 10)</span>
                    <div class="flex items-center gap-3">
                        <button onclick="updateQty(-1)" class="w-8 h-8 border rounded-lg">-</button>
                        <span id="qty-val" class="font-bold">1</span>
                        <button onclick="updateQty(1)" class="w-8 h-8 border rounded-lg">+</button>
                    </div>
                </div>

                <button onclick="gerar()" id="btn-main" class="w-full bg-inep-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">Gerar Questão</button>
            </div>

            <div id="panel-auditor" class="hidden bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center">
                <h3 class="font-bold text-emerald-800 mb-4">Auditoria Técnica</h3>
                <textarea id="audit-input" class="w-full p-3 border rounded-lg mb-4 text-sm h-64 outline-none" placeholder="Cole a questão completa..."></textarea>
                <button onclick="auditar()" id="btn-aud" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg">Executar Auditoria</button>
            </div>
        </aside>

        <div id="result-anchor" class="lg:col-span-7">
            <div class="bg-white min-h-[600px] border border-slate-200 rounded-2xl shadow-sm p-6 lg:p-12 relative flex flex-col">
                <div id="tools" class="flex justify-end gap-2 mb-6 opacity-0">
                    <button onclick="exportWord()" class="px-3 py-2 border rounded-lg text-xs font-bold text-blue-700 bg-blue-50">Word</button>
                    <button onclick="exportPdf()" class="px-3 py-2 border rounded-lg text-xs font-bold text-red-700 bg-red-50">PDF</button>
                </div>
                <div id="placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-60">
                    <i data-lucide="sparkles" class="w-12 h-12 text-slate-300 mb-4"></i>
                    <h3 class="text-xl font-bold text-slate-400">Aguardando Input</h3>
                </div>
                <div id="output" class="hidden prose prose-slate max-w-none text-sm leading-relaxed"></div>
            </div>
        </div>
    </main>

    <script>
        const TYPES = {
            "SINGLE": { label: "Resposta Única", icon: "check-circle", example: "As mitocôndrias realizam funções vitais.\n\nQual a função da mitocôndria na célula animal.\n\na) Realizar fotossíntese.\nb) Produzir ATP." },
            "INCOMPLETE": { label: "Afirmação Incompleta", icon: "pen-tool", example: "A inércia é definida na mecânica clássica como a tendência natural de um corpo em\n\na) aumentar sua velocidade constantemente.\nb) permanecer em seu estado de repouso." },
            "MULTIPLE": { label: "Complementação Múltipla", icon: "layers" },
            "ASSERTION": { label: "Asserção e Razão", icon: "git-compare" },
            "DISCURSIVE": { label: "Discursiva", icon: "file-text", example: "A IA tem transformado a educação superior.\n\nRedija um texto dissertativo analisando os impactos na aprendizagem." }
        };

        const ASSERTION_LOGIC = {
            'A': 'As asserções I e II são verdadeiras, e a II é uma justificativa correta da I.',
            'B': 'As asserções I e II são verdadeiras, mas a II não é uma justificativa correta da I.',
            'C': 'A asserção I é uma proposição verdadeira, e a II é uma proposição falsa.',
            'D': 'A asserção I é uma proposição falsa, e a II é uma proposição verdadeira.',
            'E': 'As asserções I e II são proposições falsas.'
        };

        let STATE = { bloom: 'Lembrar', type: 'SINGLE', assertionKey: 'A', multiRange: 4, quantity: 1 };

        function init() { renderTypes(); lucide.createIcons(); setBloom('Lembrar'); }

        function renderTypes() {
            const container = document.getElementById('types-container');
            container.innerHTML = '';
            Object.entries(TYPES).forEach(([key, info]) => {
                const active = STATE.type === key;
                const div = document.createElement('div');
                div.className = `type-card ${active ? 'active' : ''}`;
                div.onclick = () => { STATE.type = key; renderTypes(); };
                
                let html = `<div class="flex items-center gap-3"><i data-lucide="${info.icon}" class="w-5 h-5"></i><div class="flex-1 font-bold text-sm text-slate-800">${info.label}</div><div class="radio-circle"></div></div>`;
                
                if (active) {
                    let exText = info.example || "";
                    if (key === 'MULTIPLE') {
                        let cmd = STATE.multiRange === 3 ? "É correto o que se afirma em" : "É correto apenas o que se afirma em";
                        let alts = STATE.multiRange === 3 ? "a) I, apenas.\nb) II, apenas." : "a) I e II.\nb) II e III.";
                        exText = `Avalie as afirmações.\n\nI. Item um.\nII. Item dois.\n\n${cmd}\n\n${alts}`;
                    }
                    if (key === 'ASSERTION') {
                        exText = `Analise as seguintes asserções.\n\nI. Asserção um.\n\n<div class="text-center font-bold">PORQUE</div>\n\nII. Asserção dois.\n\nA respeito dessas asserções, assinale a opção correta.\n\na) As asserções I e II são proposições verdadeiras...`;
                    }
                    
                    html += `<div class="example-box"><div class="example-header"><i data-lucide="sparkles" class="w-3 h-3"></i> Exemplo</div><div class="whitespace-pre-line">${exText}</div></div>`;
                    
                    if (key === 'MULTIPLE') html += `<div class="mt-3 flex gap-2">${[3,4,5].map(n => `<button onclick="event.stopPropagation(); STATE.multiRange=${n}; renderTypes();" class="ctrl-btn ${STATE.multiRange===n?'active':''}">I a ${n===3?'III':n===4?'IV':'V'}</button>`).join('')}</div>`;
                    if (key === 'ASSERTION') html += `<div class="mt-3 flex gap-2">${['A','B','C','D','E'].map(l => `<button onclick="event.stopPropagation(); STATE.assertionKey='${l}'; renderTypes();" class="key-btn ${STATE.assertionKey===l?'active':''}" title="${ASSERTION_LOGIC[l]}">${l}</button>`).join('')}</div><p class="text-[10px] text-slate-500 mt-2 italic">${ASSERTION_LOGIC[STATE.assertionKey]}</p>`;
                }
                div.innerHTML = html;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function setBloom(val) {
            STATE.bloom = val;
            document.querySelectorAll('.bloom-btn').forEach(b => {
                b.className = 'bloom-btn';
                if(b.id === `bloom-${val}`) b.classList.add('active', val === 'Lembrar' || val === 'Entender' ? 'sky' : val === 'Aplicar' || val === 'Analisar' ? 'blue' : 'indigo');
            });
        }

        function updateQty(n) { STATE.quantity = Math.max(1, Math.min(10, STATE.quantity + n)); document.getElementById('qty-val').innerText = STATE.quantity; }

        function setMode(mode) {
            const isGen = mode === 'generator';
            document.getElementById('panel-generator').classList.toggle('hidden', !isGen);
            document.getElementById('panel-auditor').classList.toggle('hidden', isGen);
            document.getElementById('tab-gen').className = isGen ? "px-3 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-inep-700" : "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500";
            document.getElementById('tab-aud').className = !isGen ? "px-3 py-1.5 rounded-md text-xs font-bold bg-white shadow-sm text-inep-700" : "px-3 py-1.5 rounded-md text-xs font-bold text-slate-500";
        }

        async function gerar() {
            const btn = document.getElementById('btn-main');
            const original = btn.innerHTML;
            const curso = document.getElementById('curso').value;
            const conteudo = document.getElementById('conteudo').value;
            if(!curso || !conteudo) return alert("Preencha Curso e Conteúdo.");
            
            btn.innerHTML = 'Processando...'; btn.disabled = true;

            let promptExtras = "";
            if (STATE.type === 'ASSERTION') promptExtras = `GABARITO: ${STATE.assertionKey}. COMANDOS: Use PONTO FINAL (.) no final das instruções (ex: "Analise as asserções."). PORQUE: Deve vir em HTML centralizado: <div style="text-align:center; font-weight:bold; margin:10px 0;">PORQUE</div>.`;
            if (STATE.type === 'MULTIPLE') promptExtras = `COMANDO FINAL SEM PONTO FINAL: "${STATE.multiRange === 3 ? 'É correto o que se afirma em' : 'É correto apenas o que se afirma em'}". BALANCEAMENTO: Cada numeral romano (I a ${STATE.multiRange}) deve aparecer exatamente 3 vezes no total das alternativas A-E.`;
            if (STATE.type === 'INCOMPLETE') promptExtras = `REGRA: O enunciado NÃO deve ter pontuação final. Alternativas começam com minúscula.`;

            const prompt = `Atue como Especialista INEP. Curso: ${curso}. Tema: ${conteudo}. Tipo: ${TYPES[STATE.type].label}. Bloom: ${STATE.bloom}. Qtd: ${STATE.quantity}. NUNCA use rótulos como "TEXTO BASE". Use PONTO FINAL (.) para encerrar comandos de ligação. ${promptExtras}\nSAÍDA: (Texto suporte). (Enunciado/Comando). (Alternativas A-E verticais com linha em branco). Separador "---" para múltiplas questões.`;

            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt }) });
                const data = await res.json();
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('output').classList.remove('hidden');
                document.getElementById('tools').classList.remove('opacity-0');
                document.getElementById('output').innerHTML = marked.parse(data.text);
            } catch(e) { alert(e.message); } finally { btn.innerHTML = original; btn.disabled = false; }
        }

        async function auditar() {
            const txt = document.getElementById('audit-input').value;
            if(!txt) return alert("Cole uma questão.");
            const btn = document.getElementById('btn-aud');
            btn.innerHTML = 'Auditando...'; btn.disabled = true;
            try {
                const res = await fetch('/api/gemini', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: `ATUE COMO AUDITOR INEP. Analise estrutura e taxonomia: ${txt}` }) });
                const data = await res.json();
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('output').classList.remove('hidden');
                document.getElementById('output').innerHTML = marked.parse(data.text);
            } catch(e) { alert(e.message); } finally { btn.innerHTML = 'Executar Auditoria'; btn.disabled = false; }
        }

        function exportWord() { const text = document.getElementById('output').innerText; const doc = new docx.Document({ sections: [{ children: [new docx.Paragraph({ children: [new docx.TextRun(text)] })] }] }); docx.Packer.toBlob(doc).then(blob => saveAs(blob, "Questao.docx")); }
        function exportPdf() { const el = document.getElementById('output'); html2pdf().set({ margin: 10, filename: 'Questao.pdf' }).from(el).save(); }

        init();
    </script>
</body>
</html>
