<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academicus AI | Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }, // Azul do v√≠deo
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { background-color: #f3f4f6; color: #1f2937; } /* Fundo cinza claro igual ao v√≠deo */

        /* Estilo dos Cards de Sele√ß√£o (Bloom e Tipos) */
        .selection-card {
            border: 1px solid #e5e7eb;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }
        .selection-card:hover { border-color: #93c5fd; }
        
        /* Estado Ativo (Borda Azul e Fundo Azulzinho) */
        .selection-card.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* Inputs iguais ao do v√≠deo (Borda arredondada suave) */
        .input-video {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            width: 100%;
            outline: none;
            transition: border 0.2s;
            font-size: 0.9rem;
        }
        .input-video:focus { border-color: #3b82f6; ring: 2px solid #3b82f6; }

        /* Barra de Dificuldade (Segmentada) */
        .diff-segment { flex: 1; text-align: center; padding: 0.5rem; font-size: 0.8rem; font-weight: 600; border: 1px solid #e5e7eb; background: white; cursor: pointer; }
        .diff-segment:first-child { border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
        .diff-segment:last-child { border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
        .diff-segment.active { background-color: #3b82f6; color: white; border-color: #3b82f6; }

        /* Estilo da Resposta (Papel) */
        .prose h3 { color: #1e3a8a; font-size: 1.1rem; border-bottom: 2px solid #bfdbfe; margin-top: 1.5rem; margin-bottom: 1rem; font-weight: 700; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; text-align: justify; }
        .prose ul { list-style: none; padding: 0; }
        .prose li { margin-bottom: 0.5rem; padding: 0.5rem; border: 1px solid #f3f4f6; background: white; border-radius: 4px; }
        
        .gabarito-box { background-color: #f0fdf4; border: 1px solid #86efac; border-left: 4px solid #16a34a; padding: 1rem; margin-top: 2rem; border-radius: 6px; }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-[#0f172a] text-white h-14 flex items-center justify-between px-4 lg:px-8 shrink-0 shadow-md">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-1.5 rounded text-white"><i data-lucide="graduation-cap" class="w-5 h-5"></i></div>
            <span class="font-bold text-lg tracking-tight">Academicus AI</span>
        </div>
        <div class="flex items-center gap-2 text-xs font-medium text-slate-400">
            <i data-lucide="zap" class="w-3 h-3 text-yellow-400"></i> Powered by Gemini 3 Flash
        </div>
    </header>

    <div class="flex flex-col lg:flex-row flex-1 overflow-hidden">

        <aside class="w-full lg:w-[450px] bg-white border-r border-slate-200 flex flex-col h-auto lg:h-[calc(100vh-3.5rem)] overflow-y-auto">
            <div class="p-6 space-y-8">

                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Curso / √Årea de Conhecimento</label>
                        <input id="curso" class="input-video" placeholder="Ex: Medicina, Direito Civil, Engenharia...">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Objeto de Conhecimento</label>
                        <textarea id="conteudo" rows="3" class="input-video resize-none" placeholder="Descreva o tema espec√≠fico, compet√™ncia ou habilidade..."></textarea>
                    </div>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4 text-slate-400"></i>
                        <span class="text-xs font-bold text-slate-700 uppercase">N√≠vel de Dificuldade</span>
                    </div>
                    <div class="flex w-full">
                        <div onclick="setDiff('F√°cil')" id="diff-F√°cil" class="diff-segment">F√°cil</div>
                        <div onclick="setDiff('M√©dio')" id="diff-M√©dio" class="diff-segment active">M√©dio</div>
                        <div onclick="setDiff('Dif√≠cil')" id="diff-Dif√≠cil" class="diff-segment">Dif√≠cil</div>
                    </div>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="brain-circuit" class="w-4 h-4 text-slate-400"></i>
                        <span class="text-xs font-bold text-slate-700 uppercase">Taxonomia de Bloom</span>
                    </div>
                    <div id="bloom-container" class="space-y-2">
                        </div>
                    <div id="bloom-desc" class="mt-3 p-3 bg-blue-50 text-blue-800 text-xs rounded border border-blue-100 hidden"></div>
                </div>

                <div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="layout" class="w-4 h-4 text-slate-400"></i>
                        <span class="text-xs font-bold text-slate-700 uppercase">Modelo da Quest√£o</span>
                    </div>
                    <div id="types-container" class="space-y-2">
                        </div>
                </div>

                <div class="flex items-center justify-between border border-slate-200 p-3 rounded-lg bg-white">
                    <span class="text-sm font-bold text-slate-600 flex items-center gap-2"><i data-lucide="copy" class="w-4 h-4"></i> Quantidade</span>
                    <div class="flex items-center gap-3">
                        <button class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-bold text-slate-600">-</button>
                        <span class="text-sm font-bold">1</span>
                        <button class="w-6 h-6 rounded bg-slate-100 hover:bg-slate-200 flex items-center justify-center font-bold text-slate-600">+</button>
                    </div>
                </div>

                <button onclick="gerar()" id="btn-gerar" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2 transition-all active:scale-95">
                    <span>Gerar Quest√£o Avaliativa</span>
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 bg-slate-100 p-4 lg:p-8 overflow-y-auto flex flex-col items-center">
            
            <div id="export-tools" class="w-full max-w-3xl flex justify-end gap-2 mb-4 opacity-0 transition-opacity">
                <button onclick="exportWord()" class="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-300 rounded text-xs font-bold text-slate-700 hover:bg-slate-50 shadow-sm">
                    <i data-lucide="file-text" class="w-3 h-3"></i> Word
                </button>
                <button onclick="exportPdf()" class="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-300 rounded text-xs font-bold text-red-600 hover:bg-red-50 shadow-sm">
                    <i data-lucide="file" class="w-3 h-3"></i> PDF
                </button>
            </div>

            <div id="result-paper" class="w-full max-w-3xl bg-white min-h-[600px] rounded-lg shadow-sm border border-slate-200 p-8 lg:p-12 relative">
                
                <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center text-center p-8">
                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4">
                        <i data-lucide="sparkles" class="w-8 h-8 text-slate-300"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-400">Aguardando Input</h3>
                    <p class="text-sm text-slate-400 mt-2 max-w-xs">Preencha os par√¢metros √† esquerda e clique em "Gerar" para criar uma quest√£o de alta qualidade.</p>
                </div>

                <div id="output" class="hidden prose prose-slate max-w-none text-sm"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DADOS DO SISTEMA ---
        const BLOOM_LEVELS = [
            { name: "Criar", desc: "Colocar elementos juntos para formar um todo funcional.", verbs: "GERAR, PLANEJAR, PRODUZIR" },
            { name: "Avaliar", desc: "Fazer julgamentos baseados em crit√©rios e padr√µes.", verbs: "CHECAR, CRITICAR, JULGAR" },
            { name: "Analisar", desc: "Separar material em partes constituintes.", verbs: "DIFERENCIAR, ORGANIZAR, ATRIBUIR" },
            { name: "Aplicar", desc: "Usar um procedimento em uma determinada situa√ß√£o.", verbs: "EXECUTAR, IMPLEMENTAR, USAR" },
            { name: "Entender", desc: "Construir significado a partir de mensagens.", verbs: "RESUMIR, INFERIR, INTERPRETAR" },
            { name: "Lembrar", desc: "Recuperar conhecimento relevante da mem√≥ria.", verbs: "CITAR, DEFINIR, LISTAR" }
        ];

        const TYPES = {
            "SINGLE": { label: "Resposta √önica", icon: "check-circle-2", desc: "Quest√£o cl√°ssica com uma alternativa correta." },
            "MULTIPLE": { label: "Complementa√ß√£o M√∫ltipla", icon: "list-checks", desc: "An√°lise de itens (I, II, III)." },
            "ASSERTION": { label: "Asser√ß√£o & Raz√£o", icon: "arrow-right-left", desc: "Rela√ß√£o de causalidade (PORQUE)." },
            "DISCURSIVE": { label: "Discursiva", icon: "align-left", desc: "Quest√£o aberta com padr√£o de resposta." }
        };

        // --- ESTADO ---
        let STATE = {
            diff: 'M√©dio',
            bloom: 'Aplicar',
            type: 'SINGLE',
            assertionKey: 'A' // Para engenharia reversa
        };

        // --- RENDERIZA√á√ÉO ---
        function init() {
            renderBloom();
            renderTypes();
            lucide.createIcons();
        }

        // Renderiza a lista de Bloom igual ao v√≠deo
        function renderBloom() {
            const container = document.getElementById('bloom-container');
            const descBox = document.getElementById('bloom-desc');
            container.innerHTML = '';

            BLOOM_LEVELS.forEach(level => {
                const active = STATE.bloom === level.name;
                const div = document.createElement('div');
                div.className = `selection-card w-full p-2.5 rounded text-sm font-medium flex justify-between items-center ${active ? 'active text-blue-700' : 'text-slate-600'}`;
                div.onclick = () => { STATE.bloom = level.name; renderBloom(); };
                div.innerHTML = `<span>${level.name}</span>`;
                container.appendChild(div);

                if (active) {
                    descBox.classList.remove('hidden');
                    descBox.innerHTML = `<strong>${level.name}:</strong><br>${level.desc}<br><span class="text-[10px] mt-1 block opacity-75 font-bold">${level.verbs}</span>`;
                }
            });
        }

        // Renderiza os tipos de quest√£o
        function renderTypes() {
            const container = document.getElementById('types-container');
            container.innerHTML = '';

            Object.entries(TYPES).forEach(([key, val]) => {
                const active = STATE.type === key;
                const div = document.createElement('div');
                div.className = `selection-card w-full p-3 rounded-lg ${active ? 'active' : ''}`;
                div.onclick = () => { STATE.type = key; renderTypes(); };

                // Cabe√ßalho do Card
                let html = `
                    <div class="flex items-start gap-3">
                        <div class="${active ? 'text-blue-600' : 'text-slate-400'}"><i data-lucide="${val.icon}" class="w-5 h-5"></i></div>
                        <div>
                            <p class="text-sm font-bold ${active ? 'text-blue-800' : 'text-slate-700'}">${val.label}</p>
                            ${active ? `<p class="text-[10px] text-slate-500 mt-1">${val.desc}</p>` : ''}
                        </div>
                    </div>
                `;

                // **DETALHE DO V√çDEO**: Op√ß√µes A-E aparecem DENTRO do card quando Asser√ß√£o √© selecionada
                if (active && key === 'ASSERTION') {
                    html += `
                        <div class="mt-3 pt-2 border-t border-blue-100 animate-in fade-in slide-in-from-top-2">
                            <p class="text-[10px] font-bold text-blue-600 uppercase mb-1">Definir Gabarito (Engenharia Reversa):</p>
                            <div class="flex gap-1">
                                ${['A','B','C','D','E'].map(l => `
                                    <button onclick="event.stopPropagation(); setAssertionKey('${l}')" 
                                    class="w-8 h-8 rounded text-xs font-bold border ${STATE.assertionKey===l ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'bg-white border-slate-200 text-slate-500 hover:bg-slate-50'}">
                                    ${l}
                                    </button>
                                `).join('')}
                            </div>
                            <p class="text-[10px] text-slate-400 mt-1 italic">Gabarito for√ßado na letra ${STATE.assertionKey}</p>
                        </div>
                    `;
                }

                div.innerHTML = html;
                container.appendChild(div);
            });
            lucide.createIcons();
        }

        function setAssertionKey(key) {
            STATE.assertionKey = key;
            renderTypes(); // Re-renderiza para atualizar o estado visual dos bot√µes
        }

        function setDiff(val) {
            STATE.diff = val;
            ['F√°cil', 'M√©dio', 'Dif√≠cil'].forEach(l => {
                const el = document.getElementById(`diff-${l}`);
                if(l === val) el.className = "diff-segment active";
                else el.className = "diff-segment";
            });
        }

        // --- CONEX√ÉO COM API VERCEL (Mantendo a l√≥gica que funcionou) ---
        async function gerar() {
            const curso = document.getElementById('curso').value;
            const conteudo = document.getElementById('conteudo').value;

            if (!curso || !conteudo) return alert("Por favor, preencha o Curso e o Objeto de Conhecimento.");

            // UI de Carregamento
            const btn = document.getElementById('btn-gerar');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-5 h-5"></i> Processando...`;
            btn.disabled = true;

            // Prepara Prompt (Igual ao que j√° funcionava, s√≥ adaptado ao visual)
            let extras = "";
            if (STATE.type === 'ASSERTION') {
                extras = `
                REGRA DE OURO PARA ASSER√á√ÉO:
                1. Gere duas frases (Asser√ß√£o I e II) ligadas pela palavra PORQUE.
                2. O Gabarito TEM QUE SER a letra ${STATE.assertionKey}.
                3. Copie as alternativas padr√£o do INEP (A=I e II verdadeiras...).
                `;
            }

            const prompt = `
            ATUE COMO ESPECIALISTA DO INEP.
            Crie uma quest√£o de prova.
            
            CONFIGURA√á√ÉO:
            - Curso: ${curso}
            - Tema: ${conteudo}
            - Dificuldade: ${STATE.diff}
            - Bloom: ${STATE.bloom} (${BLOOM_LEVELS.find(b=>b.name===STATE.bloom).verbs})
            - Tipo: ${TYPES[STATE.type].label}
            ${extras}

            FORMATO DE SA√çDA (MARKDOWN):
            ### Enunciado
            (Texto contextualizado + Comando).

            ### Alternativas
            (Lista).

            <div class="gabarito-box">
            <strong>GABARITO E AN√ÅLISE</strong>
            <p>‚úÖ Resposta: (Letra)</p>
            <p>üí° Justificativa: (Explica√ß√£o detalhada).</p>
            </div>
            `;

            try {
                // Chamada segura ao backend que consertamos antes
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt })
                });

                const data = await response.json();
                
                if (data.error) throw new Error(data.error);

                // Mostra resultado
                document.getElementById('placeholder').classList.add('hidden');
                document.getElementById('export-tools').classList.remove('opacity-0');
                
                const output = document.getElementById('output');
                output.classList.remove('hidden');
                output.innerHTML = marked.parse(data.text);
                
                // Scroll suave para o resultado em Mobile
                if (window.innerWidth < 1024) {
                    output.scrollIntoView({ behavior: 'smooth' });
                }

            } catch (err) {
                alert("Erro ao conectar com a IA: " + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        // Exporta√ß√£o
        function exportWord() {
            const text = document.getElementById('output').innerText;
            const doc = new docx.Document({ sections: [{ children: [new docx.Paragraph({ children: [new docx.TextRun(text)] })] }] });
            docx.Packer.toBlob(doc).then(blob => saveAs(blob, "Questao_Academicus.docx"));
        }
        function exportPdf() {
            const el = document.getElementById('output');
            html2pdf().set({ margin: 15, filename: 'Questao_Academicus.pdf' }).from(el).save();
        }

        // Inicia
        init();
    </script>
</body>
</html>
