<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academicus AI | Núcleo de Apoio Pedagógico</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' },
                        bloomSky: { 100: '#e0f2fe', 600: '#0284c7', 800: '#075985' },
                        bloomBlue: { 100: '#dbeafe', 600: '#2563eb', 800: '#1e40af' },
                        bloomIndigo: { 100: '#e0e7ff', 600: '#4f46e5', 800: '#3730a3' }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        .input-field { transition: all 0.2s; }
        .input-field:focus { box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); border-color: #2563eb; }

        .bloom-btn { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .bloom-btn:hover { transform: scale(1.01); }
        
        .type-card { transition: all 0.3s ease; border: 1px solid #e2e8f0; cursor: pointer; }
        .type-card:hover { border-color: #93c5fd; }
        .type-card.active { border-color: #2563eb; background-color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.15); ring: 1px ring-color: #2563eb; }
        
        /* Aumentei o max-height para garantir que os textos longos e botões caibam */
        .card-content { max-height: 0; opacity: 0; overflow: hidden; transition: all 0.4s ease; }
        .type-card.active .card-content { max-height: 800px; opacity: 1; margin-top: 16px; padding-top: 16px; border-top: 1px solid #f1f5f9; }

        .qty-btn { transition: all 0.2s; }
        .qty-btn:active { transform: scale(0.95); }
        .qty-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .diff-card { transition: all 0.2s; cursor: pointer; }
        .diff-card:hover .diff-bar { opacity: 0.8; }
        .diff-bar { transition: all 0.3s ease; }

        .prose h1 { color: #1e40af; font-weight: 800; font-size: 1.5rem; margin-top: 1rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 0.5rem; }
        .prose strong { color: #1e3a8a; }
        
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="min-h-screen flex flex-col text-slate-900">

    <header class="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-50 flex items-center justify-between shadow-sm no-print">
        <div class="flex items-center gap-3">
            <div class="bg-brand-600 p-2 rounded-lg text-white shadow-md"><i data-lucide="graduation-cap"></i></div>
            <div>
                <h1 class="text-xl font-bold text-slate-900 leading-none">Academicus AI</h1>
                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Núcleo de Apoio Pedagógico</p>
            </div>
        </div>
        <div class="bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-100 font-bold text-[10px] flex items-center gap-2">
            <i data-lucide="sparkles" class="w-3 h-3"></i> Powered by Gemini 3 Flash
        </div>
    </header>

    <main class="max-w-[1600px] mx-auto p-6 grid grid-cols-1 lg:grid-cols-12 gap-8 flex-1 w-full">
        
        <aside class="lg:col-span-4 xl:col-span-3 space-y-6 no-print">
            
            <div class="bg-slate-200/50 p-1 rounded-xl flex gap-1 font-bold">
                <button onclick="setMode('generator')" id="tab-gen" class="flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 bg-white text-brand-700 shadow-sm transition-all">
                    <i data-lucide="pen-tool" class="w-3.5 h-3.5"></i> Design de Avaliação
                </button>
                <button onclick="setMode('auditor')" id="tab-aud" class="flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 text-slate-500 hover:text-slate-700 transition-all">
                    <i data-lucide="clipboard-check" class="w-3.5 h-3.5"></i> Auditoria Técnica
                </button>
            </div>

            <div id="panel-generator" class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 space-y-6">
                
                <div>
                    <h3 class="flex items-center gap-2 text-sm font-bold text-slate-800 mb-4">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4 text-brand-600"></i> Parâmetros da Questão
                    </h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase">Curso / Área de Conhecimento</label>
                            <input type="text" id="curso" class="input-field w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-sm outline-none placeholder:text-slate-400" placeholder="Ex: Medicina, Direito Civil...">
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 mb-1.5 uppercase">Objeto de Conhecimento</label>
                            <textarea id="conteudo" rows="3" class="input-field w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 text-sm outline-none placeholder:text-slate-400" placeholder="Descreva o tema específico..."></textarea>
                        </div>

                        <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
                            <label class="block text-[10px] font-bold text-slate-400 mb-1.5 uppercase flex items-center gap-1">
                                <i data-lucide="target" class="w-3 h-3"></i> Objetivo de Aprendizagem (Opcional)
                            </label>
                            <input type="text" id="objetivo" class="w-full bg-transparent text-xs outline-none text-slate-700 placeholder:text-slate-300" placeholder="Ex: Analisar criticamente...">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] font-bold text-slate-500 mb-2 uppercase flex items-center gap-1.5"><i data-lucide="bar-chart-3" class="w-3 h-3"></i> Nível de Dificuldade</label>
                    <div class="grid grid-cols-3 gap-3 h-24">
                        <button onclick="setDiff('Fácil')" id="diff-Fácil" class="diff-card group relative w-full h-full rounded-xl border border-slate-200 bg-white hover:border-sky-200 flex flex-col justify-end items-center p-2">
                            <div id="bar-Fácil" class="diff-bar w-full h-1/3 bg-slate-200 rounded-t-sm mb-2 group-hover:bg-sky-100"></div>
                            <span class="text-[10px] font-bold text-slate-400 group-hover:text-slate-500">Fácil</span>
                        </button>
                        <button onclick="setDiff('Médio')" id="diff-Médio" class="diff-card group relative w-full h-full rounded-xl border border-slate-200 bg-white hover:border-blue-200 flex flex-col justify-end items-center p-2">
                            <div id="bar-Médio" class="diff-bar w-full h-2/3 bg-blue-500 rounded-t-sm mb-2 shadow-sm"></div>
                            <span class="text-[10px] font-bold text-blue-600">Médio</span>
                        </button>
                        <button onclick="setDiff('Difícil')" id="diff-Difícil" class="diff-card group relative w-full h-full rounded-xl border border-slate-200 bg-white hover:border-indigo-200 flex flex-col justify-end items-center p-2">
                            <div id="bar-Difícil" class="diff-bar w-full h-full bg-slate-200 rounded-t-sm mb-2 group-hover:bg-indigo-100"></div>
                            <span class="text-[10px] font-bold text-slate-400 group-hover:text-slate-500">Difícil</span>
                        </button>
                    </div>
                </div>

                <div id="bloom-container" class="p-4 border border-slate-200 bg-slate-50/50 rounded-xl transition-colors">
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-[10px] font-bold text-slate-600 uppercase flex gap-1 items-center"><i data-lucide="brain-circuit" class="w-3 h-3"></i> Taxonomia de Bloom</label>
                        <span id="bloom-badge" class="text-[9px] font-bold bg-white text-slate-600 px-2 py-0.5 rounded border border-slate-200">CRIAR</span>
                    </div>
                    <div class="flex flex-col items-center gap-1">
                        <button onclick="setBloom('Criar')" id="btn-Criar" class="bloom-btn w-[50%] py-1.5 rounded text-[10px]">Criar</button>
                        <button onclick="setBloom('Avaliar')" id="btn-Avaliar" class="bloom-btn w-[60%] py-1.5 rounded text-[10px]">Avaliar</button>
                        <button onclick="setBloom('Analisar')" id="btn-Analisar" class="bloom-btn w-[70%] py-1.5 rounded text-[10px]">Analisar</button>
                        <button onclick="setBloom('Aplicar')" id="btn-Aplicar" class="bloom-btn w-[80%] py-1.5 rounded text-[10px]">Aplicar</button>
                        <button onclick="setBloom('Entender')" id="btn-Entender" class="bloom-btn w-[90%] py-1.5 rounded text-[10px]">Entender</button>
                        <button onclick="setBloom('Lembrar')" id="btn-Lembrar" class="bloom-btn w-full py-1.5 rounded text-[10px]">Lembrar</button>
                    </div>
                    <div id="bloom-desc" class="mt-3 text-[10px] text-slate-600 italic leading-relaxed bg-white p-2 rounded border border-slate-200">
                        Selecione um nível acima.
                    </div>
                </div>

                <div class="pt-4 border-t border-slate-100">
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-3">Modelo da Questão</label>
                    <div id="types-container" class="space-y-3"></div>
                </div>

                <div class="pt-4 border-t border-slate-100 space-y-4">
                    <div class="flex items-center justify-between bg-white border border-slate-200 p-3 rounded-xl shadow-sm">
                        <div class="flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4 text-slate-400"></i>
                            <span class="text-xs font-bold text-slate-700">Quantidade de Questões</span>
                        </div>
                        <div class="flex items-center gap-3 bg-slate-50 rounded-lg p-1 border border-slate-200">
                            <button onclick="updateQty(-1)" class="qty-btn w-7 h-7 flex items-center justify-center bg-white border border-slate-200 rounded text-slate-600 hover:text-brand-600"><i data-lucide="minus" class="w-3 h-3"></i></button>
                            <span id="qty-val" class="text-sm font-bold text-slate-800 w-4 text-center">1</span>
                            <button onclick="updateQty(1)" class="qty-btn w-7 h-7 flex items-center justify-center bg-white border border-slate-200 rounded text-slate-600 hover:text-brand-600"><i data-lucide="plus" class="w-3 h-3"></i></button>
                        </div>
                    </div>

                    <button onclick="gerar()" id="btn-main" class="w-full bg-slate-100 text-slate-400 font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all hover:bg-brand-600 hover:text-white hover:shadow-lg hover:shadow-brand-200 group">
                        <span>Gerar Questão Avaliativa</span>
                        <i data-lucide="chevron-right" class="w-4 h-4 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>

            <div id="panel-auditor" class="hidden bg-white rounded-2xl border border-slate-200 shadow-sm p-6 space-y-4">
                <div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100 flex gap-3">
                    <i data-lucide="microscope" class="w-5 h-5 text-emerald-600 shrink-0"></i>
                    <div>
                        <h4 class="text-xs font-bold text-emerald-800">Auditoria Técnica</h4>
                        <p class="text-[10px] text-emerald-700 mt-1">Análise psicométrica e cognitiva.</p>
                    </div>
                </div>
                <textarea id="audit-input" rows="15" class="w-full px-4 py-3 rounded-xl border border-emerald-100 bg-emerald-50/20 text-[11px] font-mono outline-none focus:border-emerald-500 text-slate-700" placeholder="Cole a questão completa aqui..."></textarea>
                <button onclick="auditar()" id="btn-aud" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center gap-2">
                    <span>Auditar Questão</span>
                    <i data-lucide="check-circle-2" class="w-4 h-4"></i>
                </button>
            </div>
        </aside>

        <div class="lg:col-span-8 xl:col-span-9 flex flex-col h-full">
            <div id="result-area" class="bg-white min-h-[850px] rounded-[2.5rem] border-2 border-dashed border-slate-200 flex flex-col items-center justify-center text-center p-12 transition-all relative">
                
                <div id="export-tools" class="hidden absolute top-8 right-8 flex gap-2 no-print z-20">
                    <button onclick="exportWord()" class="bg-white border border-slate-200 text-blue-700 px-4 py-2 rounded-lg hover:bg-blue-50 text-xs font-bold shadow-sm flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Word
                    </button>
                    <button onclick="exportPDF()" class="bg-white border border-slate-200 text-red-700 px-4 py-2 rounded-lg hover:bg-red-50 text-xs font-bold shadow-sm flex items-center gap-2">
                        <i data-lucide="file-type-2" class="w-4 h-4"></i> PDF
                    </button>
                </div>

                <div id="placeholder" class="animate-fade-in">
                    <div class="bg-slate-50 p-8 rounded-full mb-6 inline-block ring-8 ring-slate-50/50"><i data-lucide="sparkles" class="w-12 h-12 text-slate-300"></i></div>
                    <h3 class="text-xl font-bold text-slate-400 uppercase">Aguardando Input</h3>
                    <p class="text-slate-400 max-w-sm mx-auto mt-3 text-sm">Preencha os parâmetros à esquerda e clique em "Gerar" para criar uma questão de alta qualidade.</p>
                </div>
                
                <div id="ai-output" class="hidden text-left w-full max-w-4xl prose prose-slate"></div>
            </div>
        </div>
    </main>

    <script>
        // DADOS EXATOS DAS IMAGENS (NADA SIMPLIFICADO)
        const BLOOM_INFO = {
            "Criar": { verbs: "Gerar, Planejar, Produzir, Desenvolver, Combinar", desc: "Colocar elementos juntos para formar um todo coerente ou funcional.", color: "bloomIndigo" },
            "Avaliar": { verbs: "Julgar, Criticar, Julgar, Hipotetizar, Concluir", desc: "Fazer julgamentos baseados em critérios e padrões.", color: "bloomIndigo" },
            "Analisar": { verbs: "Diferenciar, Organizar, Atribuir, Comparar", desc: "Decompor o material em partes e determinar relações.", color: "bloomBlue" },
            "Aplicar": { verbs: "Executar, Implementar, Usar, Demonstrar", desc: "Usar um procedimento em uma determinada situação.", color: "bloomBlue" },
            "Entender": { verbs: "Explicar, Resumir, Inferir, Parafrasear", desc: "Construir significado a partir de mensagens.", color: "bloomSky" },
            "Lembrar": { verbs: "Citar, Definir, Listar, Identificar, Recordar", desc: "Recuperar conhecimento relevante da memória.", color: "bloomSky" }
        };

        const TYPES = {
            "SINGLE": { 
                title: "Resposta Única", 
                icon: "check-circle", 
                desc: "Formato clássico com enunciado fechado. Exige que o aluno identifique a única alternativa correta entre distractores plausíveis.", 
                example: "Enunciado: Qual estrutura celular é responsável pela respiração aeróbica?\na) Ribossomo.\nb) Mitocôndria.\nc) Complexo de Golgi.\nd) Retículo Endoplasmático." 
            },
            "INCOMPLETE": { 
                title: "Afirmação Incompleta", 
                icon: "pen-tool", 
                desc: "O enunciado é uma frase que termina abruptamente sem pontuação final. As alternativas completam a frase gramatical e semanticamente.", 
                example: "No contexto da física newtoniana, a inércia pode ser definida como a tendência de um corpo em\na) aumentar sua velocidade...\nb) permanecer em seu estado de repouso..." 
            },
            "MULTIPLE": { 
                title: "Complementação Múltipla", 
                icon: "layers", 
                desc: "Apresenta uma lista de asserções (I, II, III...) seguida de alternativas que agrupam as corretas. Exige análise combinatória de conhecimentos.", 
                example: "I. A água ferve a 100ºC ao nível do mar.\nII. O gelo é menos denso que a água líquida.\nIII. A molécula de água é apolar.\n\nÉ correto o que se afirma em\na) I, apenas.\nb) II, apenas.\nc) I e II, apenas." 
            },
            "ASSERTION": { 
                title: "Asserção e Razão", 
                icon: "git-compare", 
                desc: "Duas afirmações conectadas pela palavra PORQUE. O aluno deve julgar a veracidade de cada uma e a relação de causalidade entre elas.", 
                example: "Asserção I: O céu é azul durante o dia.\n\nPORQUE\n\nAsserção II: A atmosfera dispersa preferencialmente a luz solar de menor comprimento de onda." 
            },
            "DISCURSIVE": { 
                title: "Discursiva", 
                icon: "file-text", 
                desc: "Questão aberta que exige a produção de um texto. Inclui comando base e tópicos obrigatórios (scaffolding) para guiar a resposta.", 
                example: "Comando: Redija um texto dissertativo sobre os impactos da Inteligência Artificial na educação superior." 
            }
        };

        let state = {
            mode: 'generator',
            bloom: 'Criar',
            difficulty: 'Médio',
            type: 'SINGLE',
            quantity: 1,
            multiRange: 4,
            assertionKey: 'A'
        };

        function renderTypes() {
            const container = document.getElementById('types-container');
            container.innerHTML = '';

            Object.entries(TYPES).forEach(([key, info]) => {
                const active = state.type === key;
                const card = document.createElement('div');
                card.className = `type-card p-4 rounded-xl bg-white ${active ? 'active' : 'border-slate-200'}`;
                card.onclick = () => { state.type = key; renderTypes(); updateGenerateButton(); };

                // LOGICA DE CONTROLES EXTRAS (Agora forçada dentro do HTML)
                let extraControls = '';
                
                // Controle I-V para Complementação Múltipla
                if (key === 'MULTIPLE') {
                    extraControls = `
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <p class="text-[10px] font-bold text-brand-700 uppercase mb-2">Quantidade de Itens (I, II...)</p>
                            <div class="flex gap-2">
                                ${[3,4,5].map(n => `<button onclick="event.stopPropagation(); state.multiRange=${n}; renderTypes();" class="px-3 py-1.5 text-[10px] font-bold border rounded ${state.multiRange===n ? 'bg-brand-600 text-white border-brand-600 shadow-sm' : 'bg-white text-slate-500 hover:bg-slate-50'}">I a ${n===3?'III':n===4?'IV':'V'}</button>`).join('')}
                            </div>
                        </div>`;
                }
                
                // Controle A-E para Asserção e Razão (FIEL À IMAGEM)
                if (key === 'ASSERTION') {
                    extraControls = `
                        <div class="mt-4 pt-4 border-t border-slate-100">
                            <p class="text-[10px] font-bold text-slate-400 uppercase mb-2">DEFINIR GABARITO (ENGENHARIA REVERSA)</p>
                            <div class="flex gap-2">
                                ${['A','B','C','D','E'].map(l => `<button onclick="event.stopPropagation(); state.assertionKey='${l}'; renderTypes();" class="w-8 h-8 flex items-center justify-center text-[11px] font-bold border rounded ${state.assertionKey===l ? 'bg-brand-600 text-white border-brand-600 shadow-sm' : 'bg-white text-slate-500 hover:bg-slate-50'}">${l}</button>`).join('')}
                            </div>
                            <p class="text-[9px] text-slate-400 mt-2 italic leading-tight">
                                ${state.assertionKey === 'A' ? 'As asserções I e II são proposições verdadeiras, e a II é uma justificativa correta da I.' : 
                                  state.assertionKey === 'B' ? 'As asserções I e II são verdadeiras, mas a II NÃO é justificativa.' :
                                  'Gabarito forçado na letra ' + state.assertionKey}
                            </p>
                        </div>`;
                }

                card.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="${active?'text-brand-600':'text-slate-400'}"><i data-lucide="${info.icon}" class="w-5 h-5"></i></div>
                            <span class="text-xs font-bold ${active?'text-brand-700':'text-slate-600'}">${info.title}</span>
                        </div>
                        ${active ? '<i data-lucide="check-circle-2" class="w-4 h-4 text-brand-600"></i>' : ''}
                    </div>
                    <div class="card-content">
                        <p class="text-[10px] text-slate-500 leading-relaxed mb-3">${info.desc}</p>
                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-[10px] text-slate-600 font-mono whitespace-pre-wrap flex gap-2">
                            <i data-lucide="sparkles" class="w-3 h-3 text-brand-400 shrink-0 mt-0.5"></i>
                            <div class="leading-relaxed">${info.example}</div>
                        </div>
                        ${active ? extraControls : ''}
                    </div>
                `;
                container.appendChild(card);
            });
            lucide.createIcons();
        }

        function setMode(mode) {
            state.mode = mode;
            const isGen = mode === 'generator';
            document.getElementById('panel-generator').classList.toggle('hidden', !isGen);
            document.getElementById('panel-auditor').classList.toggle('hidden', isGen);
            document.getElementById('tab-gen').className = isGen ? 'flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 bg-white text-brand-700 shadow-sm transition-all font-bold' : 'flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 text-slate-500 hover:text-slate-700 transition-all';
            document.getElementById('tab-aud').className = !isGen ? 'flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 bg-white text-brand-700 shadow-sm transition-all font-bold' : 'flex-1 py-2.5 text-[11px] rounded-lg flex items-center justify-center gap-2 text-slate-500 hover:text-slate-700 transition-all';
        }

        function setDiff(val) {
            ['Fácil', 'Médio', 'Difícil'].forEach(level => {
                const btn = document.getElementById(`diff-${level}`);
                const bar = document.getElementById(`bar-${level}`);
                
                btn.className = 'diff-card group relative w-full h-full rounded-xl border border-slate-200 bg-white hover:border-slate-300 flex flex-col justify-end items-center p-2';
                btn.querySelector('span').className = 'text-[10px] font-bold text-slate-400 group-hover:text-slate-500';
                
                if (level === 'Fácil') bar.className = 'diff-bar w-full h-1/3 bg-slate-200 rounded-t-sm mb-2 group-hover:bg-slate-300';
                if (level === 'Médio') bar.className = 'diff-bar w-full h-2/3 bg-slate-200 rounded-t-sm mb-2 group-hover:bg-slate-300';
                if (level === 'Difícil') bar.className = 'diff-bar w-full h-full bg-slate-200 rounded-t-sm mb-2 group-hover:bg-slate-300';
            });

            const btn = document.getElementById(`diff-${val}`);
            const bar = document.getElementById(`bar-${val}`);
            
            if (val === 'Fácil') {
                btn.className = 'diff-card group relative w-full h-full rounded-xl border border-sky-300 bg-sky-50 flex flex-col justify-end items-center p-2';
                bar.className = 'diff-bar w-full h-1/3 bg-sky-400 rounded-t-sm mb-2 shadow-sm';
                btn.querySelector('span').className = 'text-[10px] font-bold text-sky-700';
            }
            if (val === 'Médio') {
                btn.className = 'diff-card group relative w-full h-full rounded-xl border border-brand-300 bg-brand-50 flex flex-col justify-end items-center p-2';
                bar.className = 'diff-bar w-full h-2/3 bg-brand-500 rounded-t-sm mb-2 shadow-sm';
                btn.querySelector('span').className = 'text-[10px] font-bold text-brand-700';
            }
            if (val === 'Difícil') {
                btn.className = 'diff-card group relative w-full h-full rounded-xl border border-indigo-300 bg-indigo-50 flex flex-col justify-end items-center p-2';
                bar.className = 'diff-bar w-full h-full bg-indigo-600 rounded-t-sm mb-2 shadow-sm';
                btn.querySelector('span').className = 'text-[10px] font-bold text-indigo-700';
            }
            state.difficulty = val;
        }

        // LÓGICA DE CORES DE BLOOM (2 em 2)
        function setBloom(val) {
            const info = BLOOM_INFO[val];
            const colorKey = info.color; 

            document.querySelectorAll('.bloom-btn').forEach(b => {
                b.className = 'bloom-btn w-full py-1.5 rounded text-[10px] text-slate-500 hover:text-slate-700 bg-white';
            });

            const activeBtn = document.getElementById(`btn-${val}`);
            if (colorKey === 'bloomSky') {
                activeBtn.className = 'bloom-btn active w-full py-1.5 rounded text-[10px] bg-sky-100 text-sky-800 border-sky-300 font-bold';
            } else if (colorKey === 'bloomBlue') {
                activeBtn.className = 'bloom-btn active w-full py-1.5 rounded text-[10px] bg-blue-100 text-blue-800 border-blue-300 font-bold';
            } else { 
                activeBtn.className = 'bloom-btn active w-full py-1.5 rounded text-[10px] bg-indigo-100 text-indigo-800 border-indigo-300 font-bold';
            }
            
            state.bloom = val;
            const badge = document.getElementById('bloom-badge');
            const container = document.getElementById('bloom-container');
            const desc = document.getElementById('bloom-desc');
            
            badge.innerText = val.toUpperCase();
            
            if (colorKey === 'bloomSky') {
                container.className = 'p-4 border border-sky-200 bg-sky-50/50 rounded-xl transition-colors';
                badge.className = 'text-[9px] font-bold bg-white text-sky-600 px-2 py-0.5 rounded border border-sky-200';
                desc.className = 'mt-3 text-[10px] text-sky-800 italic leading-relaxed bg-white p-2 rounded border border-sky-200';
            } else if (colorKey === 'bloomBlue') {
                container.className = 'p-4 border border-blue-200 bg-blue-50/50 rounded-xl transition-colors';
                badge.className = 'text-[9px] font-bold bg-white text-blue-600 px-2 py-0.5 rounded border border-blue-200';
                desc.className = 'mt-3 text-[10px] text-blue-800 italic leading-relaxed bg-white p-2 rounded border border-blue-200';
            } else {
                container.className = 'p-4 border border-indigo-200 bg-indigo-50/50 rounded-xl transition-colors';
                badge.className = 'text-[9px] font-bold bg-white text-indigo-600 px-2 py-0.5 rounded border border-indigo-200';
                desc.className = 'mt-3 text-[10px] text-indigo-800 italic leading-relaxed bg-white p-2 rounded border border-indigo-200';
            }

            desc.innerHTML = `<strong>${val}:</strong> ${info.desc} <br><span class="opacity-70 text-[9px] uppercase tracking-wide mt-1 block">Verbos: ${info.verbs}</span>`;
        }

        function updateQty(amount) {
            const newVal = state.quantity + amount;
            if (newVal >= 1 && newVal <= 10) {
                state.quantity = newVal;
                document.getElementById('qty-val').innerText = newVal;
            }
        }

        function updateGenerateButton() {
            const btn = document.getElementById('btn-main');
            btn.className = "w-full bg-brand-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg shadow-brand-200 hover:bg-brand-700 active:scale-[0.98]";
        }

        async function fetchAI(prompt, btnId) {
            const btn = document.getElementById(btnId);
            const originalHTML = btn.innerHTML;
            const resultArea = document.getElementById('result-area');
            const placeholder = document.getElementById('placeholder');
            const output = document.getElementById('ai-output');
            const tools = document.getElementById('export-tools');

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Processando...`;
            lucide.createIcons();

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ prompt })
                });
                const data = await response.json();
                
                placeholder.classList.add('hidden');
                resultArea.classList.remove('border-dashed', 'items-center', 'justify-center', 'text-center');
                resultArea.classList.add('bg-white', 'p-16', 'shadow-sm');
                
                output.innerHTML = marked.parse(data.text);
                output.classList.remove('hidden');
                tools.classList.remove('hidden');

            } catch (error) {
                alert("Erro ao conectar com a IA.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }
        }

        function gerar() {
            const curso = document.getElementById('curso').value;
            const conteudo = document.getElementById('conteudo').value;
            const objetivo = document.getElementById('objetivo').value;
            
            if (!curso || !conteudo) return alert("Preencha Curso e Objeto de Conhecimento.");
            updateGenerateButton();

            let extras = "";
            if (state.type === 'MULTIPLE') extras = `ITENS ROMANOS OBRIGATÓRIOS: I a ${state.multiRange===3?'III':state.multiRange===4?'IV':'V'}.`;
            if (state.type === 'ASSERTION') extras = `GABARITO OBRIGATÓRIO: Letra ${state.assertionKey} (Engenharia Reversa).`;

            const prompt = `
            ESPECIALISTA INEP/ENADE.
            Gere ${state.quantity} questão(ões) inédita(s) do tipo ${TYPES[state.type].title}.
            
            CONTEXTO:
            - Curso: ${curso}
            - Tema: ${conteudo}
            - Objetivo Aprendizagem: ${objetivo}
            - Dificuldade: ${state.difficulty}
            - Bloom: ${state.bloom}
            ${extras}
            
            SAÍDA:
            - Enunciado claro.
            - Alternativas (A-E).
            - Gabarito Comentado e Justificativa Pedagógica no final.
            Use separador "---" entre questões.
            `;
            fetchAI(prompt, 'btn-main');
        }

        function auditar() {
            const txt = document.getElementById('audit-input').value;
            if(!txt) return alert("Cole uma questão.");
            fetchAI(`AUDITORIA ENADE:\nAnalise psicometria e taxonomia:\n${txt}`, 'btn-aud');
        }

        async function exportWord() {
            const { Document, Packer, Paragraph, TextRun } = docx;
            const text = document.getElementById('ai-output').innerText;
            const doc = new Document({ sections: [{ children: [new Paragraph({ children: [new TextRun({text: "Academicus AI - Relatório", bold: true, size: 32}), new TextRun({text: "\n\n"+text, size: 24})]})]}]});
            const blob = await Packer.toBlob(doc);
            saveAs(blob, "Questao_Academicus.docx");
        }

        function exportPDF() {
            const el = document.getElementById('ai-output');
            html2pdf().set({ margin: 1, filename: 'Academicus.pdf' }).from(el).save();
        }

        renderTypes();
        setBloom('Criar'); 
        setDiff('Médio');
        lucide.createIcons();
    </script>
</body>
</html>
